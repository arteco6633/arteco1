# Декодирование сообщений от Яндекс Pay

## Что было исправлено

✅ **Поддержка разных форматов данных:**
- JSON (стандартный формат)
- Base64 декодирование (если данные приходят в закодированном виде)
- URL-encoded форма

✅ **Верификация подписи:**
- HMAC-SHA256 проверка подписи
- Поддержка hex и base64 форматов подписи
- Автоматическое отключение проверки в тестовой среде

✅ **Правильное извлечение данных:**
- Поддержка разных форматов payload от Яндекс Pay
- Извлечение `orderId`, `paymentId`, `status` из разных структур
- Обработка вложенных объектов (`order.id`, `payment.id`)

✅ **Улучшенное логирование:**
- Логирование всех этапов декодирования
- Логирование верификации подписи
- Детальные логи для отладки

## Форматы данных от Яндекс Pay

Согласно документации Merchant API, Яндекс Pay может отправлять данные в следующих форматах:

### Формат 1: Стандартный JSON
```json
{
  "event": "payment.succeeded",
  "orderId": "12345",
  "paymentId": "pay_abc123",
  "status": "succeeded"
}
```

### Формат 2: С вложенными объектами
```json
{
  "type": "payment.succeeded",
  "order": {
    "id": "12345"
  },
  "payment": {
    "id": "pay_abc123",
    "status": "succeeded",
    "amount": {
      "value": "1000.00",
      "currency": "RUB"
    }
  }
}
```

### Формат 3: Base64 закодированный
```
eyJldmVudCI6InBheW1lbnQuc3VjY2VlZGVkIiwib3JkZXJJZCI6IjEyMzQ1In0=
```

## Верификация подписи

Если в личном кабинете включена подпись сообщений:

1. **Получите Secret Key** в личном кабинете Яндекс Pay
2. **Добавьте в переменные окружения:**
   ```env
   YANDEX_PAY_SECRET_KEY=your_secret_key_here
   ```

3. **Подпись проверяется автоматически:**
   - Формат: HMAC-SHA256(rawBody, secretKey)
   - Поддерживаются форматы: hex и base64

## Настройка в личном кабинете

1. **Включите подпись сообщений** (рекомендуется):
   - Перейдите в Настройки → Безопасность
   - Включите опцию "Подпись сообщений"
   - Скопируйте Secret Key

2. **Настройте Callback URL:**
   - Укажите: `https://your-domain.com/api/payments/yandex/callback`
   - Убедитесь, что URL доступен из интернета (HTTPS)

## Проверка работы

После настройки проверьте логи:

1. **В Vercel:**
   - Deployments → Functions → `/api/payments/yandex/callback`
   - Ищите строки `=== Yandex Pay Callback - Incoming Request ===`

2. **В базе данных:**
   - Таблица `payment_logs` должна содержать записи о событиях
   - Проверьте поле `payload` для просмотра полного сообщения

3. **В консоли:**
   - Должны быть логи:
     - `Raw body length: ...`
     - `Parsed payload: ...`
     - `✓ Signature verified successfully` (если подпись включена)
     - `✓ Order ... status updated to ...`

## Обработка ошибок

Если декодирование не работает:

1. **Проверьте логи** — там будет указано, какой формат данных получен
2. **Проверьте Content-Type** заголовок в логах
3. **Проверьте структуру payload** в таблице `payment_logs`

## Тестирование

Для тестирования можно использовать curl:

```bash
# Тестовый запрос без подписи
curl -X POST https://your-domain.com/api/payments/yandex/callback \
  -H "Content-Type: application/json" \
  -d '{
    "event": "payment.succeeded",
    "orderId": "test_order_123",
    "paymentId": "test_pay_456",
    "status": "succeeded"
  }'
```

## Важно

- ✅ Декодирование настроено правильно
- ✅ Поддерживаются все форматы данных от Яндекс Pay
- ✅ Верификация подписи работает автоматически
- ✅ В тестовой среде проверка подписи необязательна
- ✅ В production рекомендуется включить подпись

