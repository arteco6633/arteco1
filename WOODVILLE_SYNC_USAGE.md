# Использование синхронизации остатков с Woodville

## Как это работает

1. **Парсинг по артикулу (SKU):**
   - Система ищет товар на Woodville по артикулу
   - Парсит страницу товара и извлекает остатки со складов
   - Обновляет `stock_quantity` в базе данных

2. **Обработка "Много":**
   - Если на Woodville указано "Много", в базе сохраняется `9999`
   - При отображении можно показывать "Много" вместо числа

3. **Остатки со складов:**
   - Используются остатки со склада Москва (основной склад)
   - Остатки со склада Уфа сохраняются для информации, но не используются для `stock_quantity`

## Тестирование

### Вариант 1: Ручной запуск через API

```bash
# Синхронизировать все товары с SKU
curl -X POST http://localhost:3002/api/admin/sync-stock \
  -H "Content-Type: application/json" \
  -d '{}'

# Синхронизировать конкретные товары
curl -X POST http://localhost:3002/api/admin/sync-stock \
  -H "Content-Type: application/json" \
  -d '{"productIds": [53]}'
```

### Вариант 2: Через браузер

Откройте в браузере:
```
http://localhost:3002/api/admin/sync-stock
```

Или используйте Postman/Insomnia для POST запроса.

### Вариант 3: Тестирование cron endpoint

```bash
# GET запрос для cron job
curl http://localhost:3002/api/cron/sync-woodville-stock
```

## Пример для товара с артикулом 15735

1. Убедитесь, что товар с ID 53 имеет артикул `15735` в базе данных
2. Запустите синхронизацию:
   ```bash
   curl -X POST http://localhost:3002/api/admin/sync-stock \
     -H "Content-Type: application/json" \
     -d '{"productIds": [53]}'
   ```
3. Проверьте логи в консоли сервера:
   ```
   Syncing stock for SKU: 15735 (Product ID: 53)
   SKU 15735: Moscow=Много, Ufa=null, Quantity=9999
   ✓ Updated product 53 (SKU: 15735) stock to 9999
   ```
4. Проверьте в базе данных, что `stock_quantity` обновился до `9999`

## Автоматический запуск

### Настройка в Vercel

1. Перейдите в **Settings** → **Cron Jobs**
2. Добавьте новую задачу:
   - **Name:** `sync-woodville-stock`
   - **Schedule:** `0 2 * * *` (каждый день в 2:00 UTC / 5:00 МСК)
   - **Endpoint:** `/api/cron/sync-woodville-stock`

### Настройка внешнего cron сервиса

Если используете внешний сервис (cron-job.org, EasyCron):

1. **URL:** `https://your-domain.com/api/cron/sync-woodville-stock`
2. **Schedule:** каждый день в нужное время
3. **Method:** GET
4. **Headers (опционально):** `Authorization: Bearer your_cron_secret`

## Логирование

Все действия логируются в консоль:
- Начало синхронизации
- Для каждого товара: SKU, остатки, результат обновления
- Ошибки с деталями
- Итоговая статистика

## Обработка ошибок

- Если товар не найден на Woodville → ошибка, товар пропускается
- Если артикул не указан → товар пропускается
- Если ошибка при обновлении БД → ошибка логируется, товар пропускается
- Задержка 1 секунда между запросами, чтобы не перегружать сервер Woodville

## Формат остатков

- **"Много"** → сохраняется как `9999` в `stock_quantity`
- **Число** (например, `88`) → сохраняется как есть
- **"Нет в наличии"** → сохраняется как `0`

## Что нужно для работы

1. ✅ Товары должны иметь артикул (SKU) в базе данных
2. ✅ Артикул должен совпадать с артикулом на Woodville
3. ✅ Товар должен существовать на сайте Woodville

## Улучшения в будущем

- Добавить таблицу `product_supplier_links` для хранения прямых ссылок на товары Woodville
- Добавить отображение остатков на странице товара
- Добавить интерфейс в админ-панели для управления синхронизацией
- Добавить уведомления об ошибках синхронизации

