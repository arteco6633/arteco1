# Дополнительные проблемы производительности на медленном интернете

## Найденные и исправленные проблемы

### ✅ 1. SELECT * - загрузка всех полей товаров
**Проблема:** Использовался `SELECT *`, который загружал ВСЕ поля товаров, включая большие JSONB массивы:
- `handles` (массив объектов)
- `fillings` (массив объектов)
- `hinges` (массив объектов)
- `drawers` (массив объектов)
- `lighting` (массив объектов)
- `specs` (большой JSONB объект)
- `schemes` (массив изображений)
- `videos` (массив видео URL)
- `interior_images` (массив изображений)
- `rich_content` (массив объектов)
- `downloadable_files` (массив объектов)

**Влияние:** На медленном интернете это означает:
- Размер ответа API: **50-200 KB** на товар вместо **2-5 KB**
- Для 8 товаров: **400-1600 KB** вместо **16-40 KB**
- Увеличение времени загрузки в **10-40 раз**!

**Исправлено:**
- Выбираются только нужные поля для списков товаров: `id, name, description, price, original_price, price_type, price_per_m2, image_url, images, colors, category_id, is_featured, is_new, model_3d_url`
- Размер ответа уменьшен в **10-20 раз**

### ✅ 2. Улучшен BootLoader
**Проблема:** BootLoader скрывался слишком рано, до загрузки критических данных.

**Исправлено:**
- Добавлена проверка `document.readyState === 'complete'`
- Fallback таймаут 3 секунды на случай проблем
- Плавное скрытие с анимацией

### ✅ 3. Оптимизированы запросы категорий и интерьеров
**Исправлено:**
- Категории: выбираются только `id, name, slug, image_url, is_active`
- Интерьеры: выбираются только нужные поля без больших массивов

---

## Оставшиеся потенциальные проблемы

### ⚠️ 1. framer-motion в KitchenQuiz
**Проблема:** `framer-motion` загружается синхронно в `KitchenQuiz.tsx`, даже если квиз не открыт.

**Рекомендация:**
- Компонент уже динамически импортируется, но `framer-motion` все равно попадает в bundle
- Рассмотрите замену анимаций на CSS transitions для простых анимаций

### ⚠️ 2. Размер изображений в Supabase Storage
**Проблема:** Неизвестно, какой размер и формат изображений загружаются.

**Рекомендации:**
- Проверьте размер изображений в Storage
- Используйте WebP формат
- Установите максимальный размер (например, 1200px для больших изображений, 800px для карточек)
- Используйте сжатие 80-85%

### ⚠️ 3. Отсутствие таймаутов для API запросов
**Проблема:** На медленном интернете запросы могут "висеть" долго без таймаута.

**Рекомендация:** Добавить таймауты для Supabase запросов (например, 10-15 секунд)

### ⚠️ 4. Большие JSONB поля могут быть в images/colors
**Проблема:** Даже выбрав только нужные поля, массивы `images` и `colors` могут быть большими.

**Рекомендация:** 
- Для списков товаров ограничить количество изображений (например, только первое)
- Для цветов ограничить количество (например, только первые 3)

---

## Дополнительные оптимизации

### 1. Resource Hints
Добавлены `dns-prefetch` и `preconnect`, но можно добавить больше:
```html
<link rel="preload" as="font" href="/fonts/..." crossorigin />
<link rel="prefetch" href="/catalog" />
```

### 2. Service Worker стратегия
Убедитесь, что Service Worker правильно кэширует:
- Статические ресурсы (HTML, CSS, JS)
- API ответы (с `stale-while-revalidate`)
- Изображения

### 3. Lazy Loading для всех изображений ниже fold
Убедитесь, что все изображения, которые не видны сразу, используют `loading="lazy"`

### 4. Оптимизация CSS
- Проверьте размер `globals.css`
- Убедитесь, что неиспользуемый CSS удаляется (PurgeCSS в Tailwind должен делать это автоматически)

---

## Метрики для проверки

После деплоя проверьте:

1. **Размер JavaScript bundle:**
   ```bash
   npm run build
   # Проверьте размер файлов в .next/static/chunks/
   ```

2. **Network waterfall в DevTools:**
   - Откройте DevTools → Network
   - Выберите "Slow 3G"
   - Перезагрузите страницу
   - Проверьте, какие ресурсы блокируют загрузку

3. **Lighthouse Score:**
   - Откройте DevTools → Lighthouse
   - Запустите анализ производительности
   - Проверьте метрики:
     - First Contentful Paint (FCP) - должно быть < 1.8s
     - Largest Contentful Paint (LCP) - должно быть < 2.5s
     - Time to Interactive (TTI) - должно быть < 3.8s

---

## Критичность изменений

### Критические (исправлено):
1. ✅ SELECT * → выбор только нужных полей
2. ✅ Параллельная загрузка критических данных
3. ✅ Отложенная загрузка некритических данных

### Важные (можно улучшить):
1. ⚠️ Оптимизация размера изображений
2. ⚠️ Таймауты для API запросов
3. ⚠️ Ограничение размеров массивов в ответах

### Желательные:
1. ⚠️ Замена framer-motion на CSS transitions
2. ⚠️ Дополнительные resource hints
3. ⚠️ Улучшение Service Worker стратегии

