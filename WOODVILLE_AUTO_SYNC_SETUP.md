# Настройка автоматической синхронизации остатков с Woodville

## Вариант 1: Vercel Cron Jobs (рекомендуется)

Если ваш сайт размещен на Vercel, это самый простой способ.

### Шаг 1: Проверьте файл `vercel.json`

Убедитесь, что в корне проекта есть файл `vercel.json` с настройкой cron job:

```json
{
  "framework": "nextjs",
  "crons": [
    {
      "path": "/api/cron/sync-woodville-stock",
      "schedule": "0 2 * * *"
    }
  ]
}
```

**Расписание:**
- `0 2 * * *` — каждый день в 2:00 UTC (5:00 МСК)
- `0 */6 * * *` — каждые 6 часов
- `0 9 * * 1-5` — каждый рабочий день в 9:00 UTC

### Шаг 2: Добавьте секретный ключ (опционально, но рекомендуется)

1. Перейдите в **Vercel Dashboard** → Ваш проект → **Settings** → **Environment Variables**
2. Добавьте новую переменную:
   - **Name:** `CRON_SECRET`
   - **Value:** Сгенерируйте случайную строку (например, используйте `openssl rand -hex 32`)
   - **Environment:** Production, Preview, Development (по необходимости)

**Пример генерации секрета:**
```bash
openssl rand -hex 32
```

### Шаг 3: Деплой проекта

После добавления cron job в `vercel.json` и переменных окружения:

1. Закоммитьте изменения:
   ```bash
   git add vercel.json
   git commit -m "Add cron job for stock sync"
   git push
   ```

2. Vercel автоматически задеплоит проект и активирует cron job

### Шаг 4: Проверка работы

1. Перейдите в **Vercel Dashboard** → Ваш проект → **Settings** → **Cron Jobs**
2. Вы должны увидеть задачу `sync-woodville-stock` с расписанием `0 2 * * *`
3. После первого запуска проверьте логи в **Deployments** → выберите последний деплой → **Functions** → `/api/cron/sync-woodville-stock`

## Вариант 2: Внешний сервис Cron Jobs

Если не используете Vercel или нужен более гибкий контроль, используйте внешние сервисы.

### Сервисы для cron jobs:

1. **[cron-job.org](https://cron-job.org)** (бесплатно, до 2 задач)
2. **[EasyCron](https://www.easycron.com)** (бесплатно, до 2 задач)
3. **[UptimeRobot](https://uptimerobot.com)** (бесплатно, мониторинг + cron)

### Настройка через cron-job.org:

1. **Зарегистрируйтесь** на [cron-job.org](https://cron-job.org)

2. **Создайте новую задачу:**
   - **Title:** `Woodville Stock Sync`
   - **Address (URL):** `https://your-domain.com/api/cron/sync-woodville-stock`
   - **Schedule:** Выберите расписание (например, "Daily" → "02:00 UTC")
   - **Request Method:** GET
   - **Request Headers (опционально):**
     ```
     Authorization: Bearer your_cron_secret
     ```
   - **Save** задачу

3. **Проверьте работу:**
   - После создания задачи можно нажать "Run now" для тестового запуска
   - Проверьте логи в вашем проекте

### Настройка через EasyCron:

1. **Зарегистрируйтесь** на [EasyCron.com](https://www.easycron.com)

2. **Создайте новую задачу:**
   - **Job Name:** `Woodville Stock Sync`
   - **URL:** `https://your-domain.com/api/cron/sync-woodville-stock`
   - **Schedule:** Выберите расписание
   - **HTTP Method:** GET
   - **HTTP Headers (опционально):**
     ```
     Authorization: Bearer your_cron_secret
     ```

3. **Сохраните** и активируйте задачу

## Вариант 3: Ручной запуск через API

Для тестирования или разовых синхронизаций можно запускать вручную:

### Через браузер:
```
https://your-domain.com/api/cron/sync-woodville-stock
```

### Через curl:
```bash
curl https://your-domain.com/api/cron/sync-woodville-stock
```

### С авторизацией (если настроен CRON_SECRET):
```bash
curl -H "Authorization: Bearer your_cron_secret" \
  https://your-domain.com/api/cron/sync-woodville-stock
```

## Настройка расписания

### Примеры расписаний (cron format):

```bash
# Каждый день в 2:00 UTC (5:00 МСК)
0 2 * * *

# Каждые 6 часов
0 */6 * * *

# Каждый рабочий день в 9:00 UTC
0 9 * * 1-5

# Два раза в день: утром и вечером
0 9,21 * * *

# Каждые 12 часов
0 */12 * * *

# Каждую неделю в понедельник в 3:00 UTC
0 3 * * 1
```

### Рекомендации:

- **Ежедневно** — оптимально для большинства магазинов
- **Каждые 6 часов** — если остатки меняются часто
- **Каждые 12 часов** — если остатки меняются редко
- **По требованию** — ручной запуск из админ-панели

## Проверка работы

### Логи синхронизации:

1. **В Vercel:**
   - Перейдите в **Deployments** → выберите последний деплой
   - Откройте **Functions** → `/api/cron/sync-woodville-stock`
   - Просмотрите логи выполнения

2. **В админ-панели:**
   - Откройте `/admin/stock`
   - Проверьте дату обновления товаров в колонке "Обновлено"
   - После синхронизации даты должны обновиться

3. **В базе данных:**
   - Проверьте поле `updated_at` в таблице `products`
   - Проверьте поле `stock_quantity` — должно обновиться

## Устранение проблем

### Cron job не запускается:

1. **Проверьте `vercel.json`:**
   - Убедитесь, что файл находится в корне проекта
   - Проверьте синтаксис JSON
   - Убедитесь, что путь `/api/cron/sync-woodville-stock` правильный

2. **Проверьте деплой:**
   - Убедитесь, что последний деплой успешен
   - Проверьте, что файл `vercel.json` включен в деплой

3. **Проверьте логи:**
   - В Vercel Dashboard → Deployments → Functions
   - Ищите ошибки или предупреждения

### Ошибки авторизации:

Если используете `CRON_SECRET`:

1. **Проверьте переменную окружения:**
   - Убедитесь, что `CRON_SECRET` добавлен в Vercel
   - Проверьте, что значение совпадает в запросе

2. **Проверьте заголовок:**
   - Убедитесь, что заголовок `Authorization: Bearer your_cron_secret` отправляется правильно

### Товары не синхронизируются:

1. **Проверьте артикулы:**
   - Убедитесь, что у товаров указан артикул (SKU)
   - Артикул должен совпадать с артикулом на Woodville

2. **Проверьте логи:**
   - В консоли сервера должны быть логи синхронизации
   - Ищите ошибки для конкретных товаров

3. **Проверьте доступность Woodville:**
   - Убедитесь, что сайт Woodville доступен
   - Проверьте, не блокирует ли он запросы

## Безопасность

⚠️ **Важно:**

1. **Используйте секретный ключ** для защиты от несанкционированного доступа
2. **Не коммитьте** `CRON_SECRET` в git
3. **Ограничьте доступ** к cron endpoint только через авторизацию

## Мониторинг

После настройки автоматической синхронизации:

1. **Регулярно проверяйте логи** в Vercel или внешнем сервисе
2. **Следите за ошибками** синхронизации
3. **Проверяйте остатки** в админ-панели после синхронизации

## Пример полной настройки для Vercel

1. **Добавьте в `vercel.json`:**
   ```json
   {
     "framework": "nextjs",
     "crons": [
       {
         "path": "/api/cron/sync-woodville-stock",
         "schedule": "0 2 * * *"
       }
     ]
   }
   ```

2. **Добавьте переменную окружения в Vercel:**
   - `CRON_SECRET` = `ваш_случайный_ключ`

3. **Закоммитьте и запушьте:**
   ```bash
   git add vercel.json
   git commit -m "Add automatic stock sync cron job"
   git push
   ```

4. **Проверьте в Vercel Dashboard:**
   - Settings → Cron Jobs → должна появиться задача
   - Дождитесь первого запуска (в 2:00 UTC)
   - Проверьте логи

Готово! Автоматическая синхронизация настроена и будет работать каждый день.

