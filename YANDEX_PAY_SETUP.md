# Настройка Яндекс Pay и Split

## Что было сделано

✅ Интеграция Яндекс Pay Web SDK  
✅ Поддержка Split (оплата частями)  
✅ API роуты для создания платежей и обработки callbacks  
✅ Логирование платежей в базу данных  

## Что требуется от вас

### 1. Получить данные из личного кабинета Яндекс Pay

1. **Войдите в личный кабинет:** https://console.pay.yandex.ru/settings
2. **Перейдите в раздел "Настройки"**
3. **Получите следующие данные:**

   **Для тестовой среды:**
   - Включите опцию **"Тестовые данные"** (правый верхний угол)
   - **Merchant ID** (Shop ID) — у вас уже есть: `d1c40178-a7be-40c2-add3-700b699f09cb`
   - **API Key** — нужно получить (если еще нет)

   **Для боевой среды:**
   - Отключите опцию **"Тестовые данные"**
   - **Merchant ID** (Shop ID) — должен быть тот же
   - **API Key** — нужно получить для production

### 2. Настроить Callback URL

1. **В разделе "Настройки"** найдите поле **"Callback URL"**
2. **Для тестовой среды:**
   - Укажите: `https://your-domain.com/api/payments/yandex/callback`
   - Или для локальной разработки: `https://your-ngrok-url.ngrok.io/api/payments/yandex/callback`

3. **Для боевой среды:**
   - Укажите: `https://www.arteeeco.ru/api/payments/yandex/callback`

### 3. Добавить переменные окружения

Добавьте в `.env.local` (для локальной разработки) и в Vercel (для production):

```env
# Яндекс Pay Configuration
YANDEX_PAY_MERCHANT_ID=d1c40178-a7be-40c2-add3-700b699f09cb
YANDEX_PAY_API_KEY=your_api_key_here  # Получите в личном кабинете
YANDEX_PAY_ENV=test  # 'test' для тестовой среды, 'production' для боевой
YANDEX_PAY_ENABLE_SPLIT=true  # Включить Split (оплата частями)

# Для клиентской части (Web SDK)
NEXT_PUBLIC_YANDEX_PAY_MERCHANT_ID=d1c40178-a7be-40c2-add3-700b699f09cb
```

### 4. Настроить Split (оплата частями)

Split уже интегрирован в код. Для его активации:

1. **Убедитесь, что `YANDEX_PAY_ENABLE_SPLIT=true`** в переменных окружения
2. **В личном кабинете Яндекс Pay:**
   - Перейдите в раздел настроек Split
   - Активируйте Split для вашего магазина
   - Настройте условия (минимальная сумма, количество частей и т.д.)

3. **Split будет доступен:**
   - В корзине появится опция "Частями с Яндекс Сплит"
   - Минимальная сумма для Split: 3000 рублей (можно изменить в коде)

### 5. Тестирование

#### Тестовая среда:

1. **Убедитесь, что в `.env.local`:**
   ```env
   YANDEX_PAY_ENV=test
   YANDEX_PAY_MERCHANT_ID=d1c40178-a7be-40c2-add3-700b699f09cb
   ```

2. **Добавьте товар в корзину**
3. **Выберите "Оплата Яндекс Пэй"** или **"Частями с Яндекс Сплит"**
4. **Нажмите кнопку оплаты**
5. **Должно открыться окно Яндекс Pay** с тестовыми данными

#### Боевая среда:

1. **После получения уведомления о подключении** от Яндекс Pay
2. **Обновите переменные окружения:**
   ```env
   YANDEX_PAY_ENV=production
   YANDEX_PAY_API_KEY=your_production_api_key
   ```

3. **Убедитесь, что Callback URL настроен** для production
4. **Проведите тестовый платеж** в боевой среде

## Структура интеграции

### API Роуты:

- **`/api/payments/yandex/create`** — создание платежа (получение параметров для SDK)
- **`/api/payments/yandex/callback`** — обработка webhook от Яндекс Pay

### Клиентская часть:

- **Web SDK Яндекс Pay** загружается автоматически
- **Кнопки оплаты** в корзине:
  - "Оплата Яндекс Пэй" — обычная оплата
  - "Частями с Яндекс Сплит" — оплата частями

### Логирование:

- Все события платежей логируются в таблицу `payment_logs`
- Статусы заказов обновляются автоматически через callback

## Документация

- **Официальная документация:** https://pay.yandex.ru/docs/ru/custom/integration-guide
- **Web SDK:** https://pay.yandex.ru/docs/ru/custom/web-sdk/
- **Split:** https://pay.yandex.ru/docs/ru/custom/

## Важные моменты

1. **Merchant ID** у вас уже есть: `d1c40178-a7be-40c2-add3-700b699f09cb`
2. **API Key** нужно получить в личном кабинете (если еще нет)
3. **Callback URL** должен быть доступен из интернета (HTTPS)
4. **Split** требует отдельной активации в личном кабинете
5. **Тестовая среда** использует тестовые карты (см. документацию Яндекс Pay)

## Следующие шаги

1. ✅ Получите API Key в личном кабинете
2. ✅ Добавьте переменные окружения в `.env.local` и Vercel
3. ✅ Настройте Callback URL в личном кабинете
4. ✅ Протестируйте в тестовой среде
5. ✅ Активируйте Split в личном кабинете (если нужно)
6. ✅ После одобрения переключитесь на production

## Поддержка

Если возникнут проблемы:
- Проверьте логи в Vercel → Deployments → Functions
- Проверьте таблицу `payment_logs` в Supabase
- Обратитесь в поддержку Яндекс Pay: https://pay.yandex.ru/docs/ru/support/

