# Настройка интеграции с Долями

Интеграция с платежным сервисом "Долями" позволяет вашим клиентам оплачивать покупки частями.

## Шаги подключения

### 0. Интеграция сниппета (уже выполнена)

Сниппет Долями уже интегрирован в проект и будет автоматически загружаться на всех страницах сайта. 

**Что нужно сделать:**
- Получить **Site ID** от менеджера Долями
- Добавить `NEXT_PUBLIC_DOLYAME_SITE_ID` в `.env.local`

После этого сниппет начнет работать и на сайте появятся промо-элементы Долями (виджеты в карточках товаров, графики оплаты в корзине и т.д.).

**Документация по сниппету:** https://dolyame.ru/develop/api/integrationscript/

### 1. Подача заявки на подключение

1. Перейдите на [страницу подключения Долями](https://dolyame.ru/help/business/selling/connect/)
2. Заполните форму заявки, указав:
   - Контактные данные
   - Информацию о компании
   - ИНН и другие реквизиты

### 2. Получение учетных данных

После обработки заявки с вами свяжется персональный менеджер Долями, который:
- Уточнит детали о вашем бизнесе
- Предоставит **логин** и **пароль** для доступа к API
- Предоставит **Site ID** для сниппета (уникальный идентификатор сайта)
- Отправит инструкции по выпуску mTLS сертификата

### 3. Выпуск mTLS сертификата

Для безопасного взаимодействия с API Долями требуется mTLS (mutual TLS) сертификат.

**Инструкции:**
- Подробная инструкция: https://dolyame.ru/develop/api/preparation/
- Выпуск сертификата в личном кабинете Т‑Бизнеса

**Что нужно получить:**
- Клиентский сертификат (`client.crt`)
- Приватный ключ (`client.key`)
- CA сертификат (`ca.crt`, опционально)

### 4. Настройка переменных окружения

Добавьте следующие переменные в ваш `.env.local` файл (для локальной разработки) и в настройки Vercel (для production):

```env
# Долями (Dolyame) Payment Configuration
DOLYAME_LOGIN=your_login  # Логин от личного кабинета Долями
DOLYAME_PASSWORD=your_password  # Пароль от личного кабинета Долями
DOLYAME_API_URL=https://partner.dolyame.ru/v1/orders  # Production URL

# Пути к mTLS сертификатам
DOLYAME_CERT_PATH=/path/to/client.crt  # Путь к клиентскому сертификату
DOLYAME_KEY_PATH=/path/to/client.key  # Путь к приватному ключу
DOLYAME_CA_PATH=/path/to/ca.crt  # Путь к CA сертификату (опционально)
```

**Важно:**
- Сертификаты должны быть в формате PEM
- Убедитесь, что пути к сертификатам указаны правильно
- На Vercel сертификаты можно хранить в Secrets или загружать через переменные окружения (base64)

### 5. Настройка на Vercel (для production)

Если вы используете Vercel для деплоя:

1. **Перейдите в настройки проекта** → **Environment Variables**
2. **Добавьте переменные:**
   - `DOLYAME_LOGIN`
   - `DOLYAME_PASSWORD`
   - `DOLYAME_API_URL`
   - `DOLYAME_CERT_PATH` (или используйте Secrets для хранения сертификата)
   - `DOLYAME_KEY_PATH` (или используйте Secrets для хранения ключа)
   - `DOLYAME_CA_PATH` (опционально)

3. **Для сертификатов на Vercel:**
   - Можно использовать Vercel Secrets для хранения содержимого сертификатов
   - Или загрузить сертификаты в файловую систему при деплое

### 6. Тестирование

После настройки:

1. **Создайте тестовый заказ** в корзине
2. **Выберите способ оплаты** "Оплата частями с Долями"
3. **Нажмите кнопку** "Оплатить частями с Долями"
4. **Проверьте логи** в Vercel или локально:
   - Ищите строки `=== Долями Create Order - Incoming Request ===`
   - Проверьте ответ от API Долями

### 7. Проверка callback'ов

После успешной оплаты Долями отправит callback на:
```
https://your-domain.com/api/payments/dolyame/callback
```

**Проверьте:**
- Callback'и записываются в таблицу `payment_logs`
- Статус заказа обновляется автоматически

## Структура интеграции

### API Роуты

1. **`/api/payments/dolyame/create`** — создание заявки на оплату частями
   - Принимает: `amount`, `orderId`, `items`, `customer`
   - Возвращает: `paymentUrl` для редиректа пользователя

2. **`/api/payments/dolyame/callback`** — обработка уведомлений от Долями
   - Обновляет статус заказа в базе данных
   - Логирует события в `payment_logs`

### Статусы заказов

Долями отправляет следующие статусы:
- `approved` / `paid` → статус заказа: `paid`
- `rejected` / `cancelled` → статус заказа: `cancelled`
- `refunded` → статус заказа: `refunded`

## Поддержка

Если возникли проблемы:

1. **Проверьте логи** в Vercel или локально
2. **Убедитесь**, что все переменные окружения настроены правильно
3. **Проверьте**, что mTLS сертификаты загружены и доступны
4. **Обратитесь в поддержку Долями:**
   - Email: partners@dolyame.ru
   - Телефон: +7 800 555-42-24

## Дополнительная документация

- [Официальная документация API Долями](https://dolyame.ru/develop/api/)
- [Подготовка к интеграции](https://dolyame.ru/develop/api/preparation/)
- [Методы API](https://dolyame.ru/develop/api/methods/)

