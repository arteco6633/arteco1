# Диагностика проблем с Яндекс Pay SDK

## Проблема: SDK не загружается на production

### Симптомы:
- Ошибка "Failed to load Yandex Pay SDK"
- Ошибка "SDK load timeout"
- SDK не загружается даже на HTTPS домене
- **"SDK script already in DOM, waiting..."** - скрипт есть в DOM, но объект `YaPay` не появляется
- **"SDK script exists but YaPay object not found"** - скрипт загружен, но не выполняется

### Возможные причины и решения:

#### 1. Домен не добавлен в белый список в консоли Яндекс Pay

**Решение:**
1. Войдите в личный кабинет: https://console.pay.yandex.ru/settings
2. Перейдите в раздел "Настройки"
3. Найдите раздел "Разрешенные домены" или "Allowed Domains"
4. Добавьте ваш домен: `arteeeco.ru` и `www.arteeeco.ru`
5. Сохраните изменения

**Важно:** Яндекс Pay может блокировать загрузку SDK с доменов, которые не добавлены в белый список.

#### 2. CORS ошибки

**Проверка:**
- Откройте консоль браузера (F12)
- Перейдите на вкладку "Network"
- Найдите запрос к `https://pay.yandex.ru/sdk/v2/pay.js`
- Проверьте статус ответа и заголовки CORS

**Решение:**
- Убедитесь, что домен добавлен в белый список (см. пункт 1)
- Проверьте, что используется HTTPS (не HTTP)
- Проверьте настройки CORS в консоли Яндекс Pay

#### 3. Блокировка скрипта браузером или расширениями

**Проверка:**
- Отключите все расширения браузера
- Попробуйте в режиме инкогнито
- Проверьте настройки безопасности браузера

**Решение:**
- Добавьте домен в исключения блокировщиков рекламы
- Проверьте настройки антивируса/брандмауэра

#### 4. Проблемы с переменными окружения

**Проверка:**
Убедитесь, что в Vercel настроены следующие переменные:

```env
YANDEX_PAY_MERCHANT_ID=d1c40178-a7be-40c2-add3-700b699f09cb
YANDEX_PAY_API_KEY=your_api_key_here
YANDEX_PAY_ENV=production  # или 'test' для тестовой среды
NEXT_PUBLIC_YANDEX_PAY_MERCHANT_ID=d1c40178-a7be-40c2-add3-700b699f09cb
```

**Решение:**
- Проверьте значения в Vercel → Settings → Environment Variables
- Убедитесь, что переменные добавлены для production окружения
- Пересоберите проект после изменения переменных

#### 5. Проблемы на стороне сервера Яндекс Pay

**Проверка:**
- Проверьте статус сервиса: https://status.yandex.ru/
- Попробуйте загрузить SDK напрямую в браузере: `https://pay.yandex.ru/sdk/v2/pay.js`

**Решение:**
- Если SDK не загружается напрямую, проблема на стороне Яндекс Pay
- Обратитесь в поддержку: https://pay.yandex.ru/docs/ru/support/

### Диагностические шаги:

1. **Проверьте консоль браузера:**
   ```javascript
   // В консоли браузера выполните:
   console.log('YaPay available:', typeof window.YaPay !== 'undefined')
   console.log('Scripts:', document.querySelectorAll('script[src*="pay.yandex.ru"]').length)
   ```

2. **Проверьте Network tab (КРИТИЧНО!):**
   - Откройте DevTools → Network
   - Обновите страницу
   - Найдите запрос к `pay.yandex.ru/sdk/v2/pay.js`
   - **Проверьте статус ответа:**
     - ✅ Должен быть **200 OK**
     - ❌ Если **404** - URL неправильный
     - ❌ Если **403** - домен не в белом списке или CORS ошибка
     - ❌ Если **CORS error** - домен не добавлен в белый список Яндекс Pay
   - **Проверьте заголовки ответа:**
     - `Content-Type` должен быть `application/javascript` или `text/javascript`
     - Проверьте наличие CORS заголовков
   - **Проверьте Response:**
     - Откройте вкладку "Response" или "Preview"
     - Должен быть виден JavaScript код
     - Если пусто или ошибка - проблема на стороне Яндекс Pay

3. **Проверьте DOM:**
   ```javascript
   // В консоли браузера:
   const scripts = document.querySelectorAll('script[src*="pay.yandex.ru"]')
   scripts.forEach(s => console.log('Script:', s.src, 'Loaded:', s.complete))
   ```

4. **Проверьте события:**
   ```javascript
   // В консоли браузера:
   window.addEventListener('yandex-pay-sdk-loaded', () => {
     console.log('✓ SDK loaded event fired')
   })
   window.addEventListener('yandex-pay-sdk-error', (e) => {
     console.error('✗ SDK error event:', e.detail)
   })
   ```

### Что было исправлено в коде:

1. ✅ Улучшена логика загрузки SDK с множественными проверками
2. ✅ Добавлена альтернативная динамическая загрузка SDK
3. ✅ Улучшена обработка ошибок с детальными сообщениями
4. ✅ Добавлены события для отслеживания загрузки SDK
5. ✅ Исправлен URL SDK в сообщениях об ошибках (v1 → v2)
6. ✅ Увеличен таймаут ожидания SDK (15 → 20 секунд)
7. ✅ Добавлена детальная диагностика статуса скрипта в DOM
8. ✅ Улучшена проверка существующих скриптов перед динамической загрузкой
9. ✅ Добавлено логирование всех глобальных объектов для отладки

### Важно: Если скрипт есть в DOM, но объект YaPay не появляется

Это означает, что:
- ✅ Скрипт успешно загружен (HTTP 200)
- ❌ Скрипт **не выполняется** или выполняется с ошибкой

**Возможные причины:**
1. **Домен не в белом списке** - Яндекс Pay блокирует выполнение скрипта
2. **CORS ошибка** - браузер блокирует выполнение из-за политики безопасности
3. **JavaScript ошибка в скрипте** - проверьте консоль на наличие ошибок
4. **Блокировка браузером/расширениями** - скрипт загружен, но выполнение заблокировано

**Решение:**
1. **Проверьте Network tab:**
   - Статус должен быть 200
   - Response должен содержать JavaScript код
   - Нет CORS ошибок в консоли
2. **Проверьте Console tab:**
   - Нет JavaScript ошибок при выполнении скрипта
   - Нет сообщений о блокировке
3. **Проверьте настройки домена в консоли Яндекс Pay:**
   - Домен должен быть добавлен в белый список
   - Используйте точное доменное имя: `arteeeco.ru` и `www.arteeeco.ru`

### Следующие шаги:

1. Проверьте настройки домена в консоли Яндекс Pay
2. Проверьте переменные окружения в Vercel
3. Проверьте консоль браузера на наличие ошибок
4. Попробуйте загрузить SDK напрямую в браузере
5. Если проблема сохраняется, обратитесь в поддержку Яндекс Pay

### Полезные ссылки:

- Консоль Яндекс Pay: https://console.pay.yandex.ru/settings
- Документация: https://pay.yandex.ru/docs/ru/custom/integration-guide
- Поддержка: https://pay.yandex.ru/docs/ru/support/
- Статус сервиса: https://status.yandex.ru/

